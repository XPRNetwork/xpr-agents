# XPR Agents - Pre-Testnet Security Audit Report
**Date:** 2026-02-05
**Auditors:** 8 Parallel Analysis Agents
**Status:** Issues Identified - Fixes In Progress

---

## Executive Summary

Comprehensive security audit of all 4 smart contracts (agentcore, agentfeed, agentvalid, agentescrow) and deployment infrastructure before testnet deployment.

**Total Issues Found:**
- Critical: 18
- High: 23
- Medium: 31
- Low: 15+

---

## CRITICAL ISSUES (Must Fix Before Deployment)

### 1. Authorization Vulnerabilities (agentfeed)

#### 1.1 `recalculate()` Missing Auth Check
- **File:** `contracts/agentfeed/assembly/agentfeed.contract.ts`
- **Line:** 562
- **Issue:** Anyone can call `recalculate()` to manipulate agent scores
- **Risk:** Complete score integrity compromise, DoS via expensive recalculations
- **Fix:** Add `requireAuth(agent)` or `requireAuth(config.owner)`

#### 1.2 `reinstateFeedback()` Missing Auth Check
- **File:** `contracts/agentfeed/assembly/agentfeed.contract.ts`
- **Line:** 531
- **Issue:** Anyone can reinstate ANY disputed feedback
- **Risk:** Reputation manipulation, agents can collude to restore damaging disputes
- **Fix:** Add `requireAuth(config.owner)` - only owner should reinstate

### 2. Deployment Script Parameter Mismatch

#### 2.1 agentcore::init Wrong Parameters
- **Files:**
  - `scripts/deploy-testnet.sh` line 96
  - `scripts/deploy-mainnet.sh` line 118
- **Issue:** Scripts call init with `unstake_delay` parameter which doesn't exist
- **Expected:** `init(owner, min_stake, feed_contract, valid_contract, escrow_contract)`
- **Actual Call:** `init(owner, min_stake, unstake_delay)` - WILL FAIL
- **Risk:** Deployment completely fails
- **Fix:** Update scripts to pass correct parameters

#### 2.2 Missing agentescrow in setup-accounts.sh
- **File:** `scripts/setup-accounts.sh` line 35
- **Issue:** Only creates 3 accounts, missing agentescrow
- **Fix:** Add `$AGENT_ESCROW` to account creation loop

### 3. Score Calculation Incoherence (agentfeed)

#### 3.1 Dispute/Reinstate Flow Bug
- **File:** `contracts/agentfeed/assembly/agentfeed.contract.ts`
- **Lines:** 494-560
- **Issue:** When dispute is rejected and reinstated:
  1. `submit()` adds score via `updateAgentScore(..., true)`
  2. `dispute()` marks feedback.disputed = true
  3. `resolve(upheld=false)` sets feedback.resolved = true but doesn't restore score
  4. `reinstateFeedback()` clears disputed flag but score was never subtracted for pending disputes
  5. `recalculate()` recalculates from scratch - score may jump
- **Risk:** Trust scores become unreliable and manipulable
- **Fix:** Clarify logic - score should only be subtracted when dispute is UPHELD, not when created

### 4. Integer Overflow Risks

#### 4.1 Score Multiplication Overflow
- **File:** `contracts/agentfeed/assembly/agentfeed.contract.ts`
- **Line:** 614
- **Expression:** `(totalScore * 10000) / totalWeight`
- **Issue:** `totalScore * 10000` can overflow u64
- **Fix:** Add overflow check before multiplication

#### 4.2 Platform Fee Overflow
- **File:** `contracts/agentescrow/assembly/agentescrow.contract.ts`
- **Line:** 811
- **Expression:** `(amount * config.platform_fee) / 10000`
- **Issue:** Large amounts with fees can overflow
- **Fix:** Add overflow check

#### 4.3 Milestone Accumulation Overflow
- **File:** `contracts/agentescrow/assembly/agentescrow.contract.ts`
- **Line:** 353
- **Issue:** Sum of milestones can overflow, wrapping to small value and passing validation
- **Fix:** Check for overflow during accumulation

### 5. Schema Mismatches (Cross-Contract)

#### 5.1 AgentRef Missing Fields
- **File:** `contracts/agentfeed/assembly/agentfeed.contract.ts`
- **Lines:** 263-284
- **Issue:** AgentRef class missing `stake` and `total_jobs` fields that exist in agentcore
- **Risk:** Binary deserialization mismatch if fields added
- **Fix:** Add missing fields to match agentcore Agent table

#### 5.2 UserInfo Type Mismatch
- **Files:**
  - `agentcore.contract.ts` line 56: `verified: u8`
  - `agentfeed.contract.ts` line 293: `verified: boolean`
- **Issue:** Type mismatch between contracts
- **Risk:** Deserialization failure
- **Fix:** Align to u8 (actual eosio.proton type)

---

## HIGH SEVERITY ISSUES

### Security

#### H1. State Change Before External Calls (Reentrancy Risk)
- **File:** `contracts/agentvalid/assembly/agentvalid.contract.ts`
- **Lines:** 555-572
- **Issue:** Validator stake modified, then token transfer sent
- **Fix:** Update table AFTER all state changes, BEFORE external calls

#### H2. Unchecked U64.parseInt() on Memo
- **Files:**
  - `agentvalid.contract.ts` line 645
  - `agentescrow.contract.ts` line 763
- **Issue:** `U64.parseInt(challengeIdStr)` can panic on invalid input
- **Fix:** Validate memo format before parsing

#### H3. No Upper Bound on Challenge Stake
- **File:** `contracts/agentvalid/assembly/agentvalid.contract.ts`
- **Lines:** 638-653
- **Issue:** Challenger can send any amount, inflating rewards
- **Fix:** Refund excess above `config.challenge_stake`

#### H4. Plugin Results Not Verified
- **File:** `contracts/agentcore/assembly/agentcore.contract.ts`
- **Lines:** 544-567
- **Issue:** Plugin can submit results for any agent, not just those using the plugin
- **Fix:** Verify agent has plugin enabled before accepting results

### Business Logic

#### H5. Decay Calculation Integer Division
- **File:** `contracts/agentfeed/assembly/agentfeed.contract.ts`
- **Line:** 585
- **Issue:** `ageSeconds / config.decay_period` truncates, causing 5% jumps
- **Fix:** Use fixed-point arithmetic for smoother decay

#### H6. Validator Accuracy Cold Start
- **File:** `contracts/agentvalid/assembly/agentvalid.contract.ts`
- **Lines:** 574-578
- **Issue:** New validator starts at 100%, drops to 0% on first challenged validation
- **Fix:** Implement minimum sample size before accuracy is meaningful

#### H7. Challenge Funding Limbo
- **File:** `contracts/agentvalid/assembly/agentvalid.contract.ts`
- **Lines:** 479-481
- **Issue:** Challenge can be stuck between grace period end and funding deadline
- **Fix:** Allow cancellation anytime if unfunded, or auto-expire

#### H8. Milestone Sum Not Enforced
- **File:** `contracts/agentescrow/assembly/agentescrow.contract.ts`
- **Lines:** 349-355
- **Issue:** Milestones can sum to less than job amount
- **Fix:** Document or enforce that remaining funds release on final approval

#### H9. Multiple Disputes Per Job
- **File:** `contracts/agentescrow/assembly/agentescrow.contract.ts`
- **Lines:** 492-544
- **Issue:** Both client and agent can create separate disputes
- **Fix:** Check if dispute already exists for job before creating

### Data Integrity

#### H10. PaymentProof Foreign Key Not Validated
- **File:** `contracts/agentfeed/assembly/agentfeed.contract.ts`
- **Lines:** 886-899
- **Issue:** Can create payment proof with invalid feedback_id
- **Fix:** Validate feedback exists before storing

#### H11. Feedback Disputes Can Reference Non-Existent Feedback
- **File:** `contracts/agentfeed/assembly/agentfeed.contract.ts`
- **Lines:** 478-491
- **Issue:** Dispute can be created without validating feedback_id
- **Fix:** Already validated via requireGet - ACTUALLY SAFE

#### H12. No Cascade Delete for Milestones
- **File:** `contracts/agentescrow/assembly/agentescrow.contract.ts`
- **Lines:** 628-647
- **Issue:** Job cancellation doesn't delete milestones
- **Fix:** Delete all milestones when job is cancelled

#### H13. Unbounded Table Growth
- **Files:** Multiple
- **Tables:** pluginres, challenges, unstakes, extscores
- **Issue:** Records accumulate indefinitely
- **Fix:** Implement cleanup mechanisms or expiration

---

## MEDIUM SEVERITY ISSUES

### Arithmetic Safety
- Weight accumulation overflow (agentfeed:1114)
- Validator stake addition overflow (agentvalid:571)
- Released amount overflow (agentescrow:822)
- Arbitrator stake overflow (agentescrow:789)
- Counter increments without bounds (multiple)
- Hash function overflow in hashString() (agentcore:101)

### Logic Issues
- No agent deregistration action (agentcore)
- Milestone approval order not enforced (agentescrow:421)
- Context scores don't decay with time (agentfeed)
- Validator can deactivate to avoid challenges (agentvalid:309)
- Self-challenge not prevented (agentvalid:417)
- Arbitrator stake not re-validated at job creation (agentescrow)

### Configuration
- Hardcoded 60/40 trust weighting (agentfeed:944)
- Hardcoded context validation list (agentfeed:647)
- KYC level capped at 3 in agentfeed but not agentcore
- Missing tsconfig.json in contracts
- No test files exist

---

## LOW SEVERITY ISSUES

- Zero-amount milestones allowed
- Milestone ordering not enforced
- Plugin byName index documented but not implemented
- PaymentProof byPayer index defined but never used
- Directional trust clamping happens after addition
- Inconsistent TableStore caching patterns

---

## FIX TRACKING

### Phase 1: Critical Fixes (Blocking Deployment)

| # | Issue | File | Status |
|---|-------|------|--------|
| C1 | Add auth to recalculate() | agentfeed.contract.ts | ✅ DONE |
| C2 | Add auth to reinstateFeedback() | agentfeed.contract.ts | ✅ DONE |
| C3 | Fix deployment script init params | deploy-testnet.sh | ✅ DONE |
| C4 | Fix deployment script init params | deploy-mainnet.sh | ✅ DONE |
| C5 | Add agentescrow to setup-accounts.sh | setup-accounts.sh | ✅ DONE |
| C6 | Fix AgentRef schema in agentfeed | agentfeed.contract.ts | ✅ DONE (was correct) |
| C7 | Fix UserInfo type mismatch | agentfeed.contract.ts | ✅ DONE |
| C8 | Add overflow check to score calc | agentfeed.contract.ts | ✅ DONE |
| C9 | Add overflow check to fee calc | agentescrow.contract.ts | ✅ DONE |
| C10 | Add overflow check to milestone sum | agentescrow.contract.ts | ✅ DONE |

### Phase 2: High Priority Fixes (Before Testnet)

| # | Issue | File | Status |
|---|-------|------|--------|
| H1 | Fix reentrancy in resolveChallenge | agentvalid.contract.ts | ✅ DONE |
| H2 | Validate memo parsing | agentvalid.contract.ts, agentescrow.contract.ts | ✅ DONE |
| H3 | Cap challenge stake | agentvalid.contract.ts | ✅ DONE |
| H4 | Verify plugin-agent relationship | agentcore.contract.ts | ✅ DONE |
| H6 | Validator accuracy cold start | agentvalid.contract.ts | ✅ DONE |
| H7 | Challenge funding limbo | agentvalid.contract.ts | ✅ DONE (previous session) |
| H9 | Prevent duplicate job disputes | agentescrow.contract.ts | ✅ DONE |
| H12 | Add cascade delete for milestones | agentescrow.contract.ts | ✅ DONE |

### Phase 3: Medium Priority (Before Mainnet)

| # | Issue | File | Status |
|---|-------|------|--------|
| M1-M6 | Arithmetic overflow checks | Multiple | ⬜ TODO |
| M7 | Agent deregistration | agentcore.contract.ts | ⬜ TODO |
| M8 | Table cleanup mechanisms | Multiple | ⬜ TODO |

---

## Changes Log

### 2026-02-05 - Initial Fixes (Previous Session)

1. **agentvalid.contract.ts** - Challenge deadlock fix
   - Added `funding_deadline` field to Challenge table
   - Added `cancelChallenge` action
   - Added `expireUnfundedChallenge` action

2. **agentvalid.contract.ts** - Slash validation fix
   - Added check: remaining stake must be 0 or >= min_stake
   - Auto-deactivate validator if fully slashed

3. **agentvalid.contract.ts** - Self-validation prevention
   - Added `check(validator != agent, "Validators cannot validate their own work")`

4. **agentfeed.contract.ts** - Feedback reinstatement
   - Added `reinstateFeedback` action to clear disputed flag after rejected disputes

5. **agentescrow.contract.ts** - Over-funding fix
   - Modified `onTransfer` to refund excess and store only job.amount

6. **agentescrow.contract.ts** - Milestone check in approval
   - Added milestone completion verification in `approveDelivery`

7. **agentescrow.contract.ts** - Timeout fee fix
   - Changed direct `sendTokens` to use `releasePayment` for delivered jobs

8. **agentescrow.contract.ts** - incjobs integration
   - Added `incrementAgentJobs` helper
   - Called in `approveDelivery`, `claimTimeout`, `arbitrateDispute`

9. **agentescrow.contract.ts** - Arbitrator auth fix
   - Moved `requireAuth(arbitrator)` before permission checks

10. **deploy-mainnet.sh** - Added agentescrow
    - Added all agentescrow references (config, build, verify, deploy, inline, init, output)

### 2026-02-05 - Critical Fixes (Current Session)

11. **agentfeed.contract.ts** - Auth fix for recalculate() (C1)
    - Added `hasAuth(agent) || hasAuth(config.owner)` check
    - Prevents DoS via expensive recalculations by unauthorized parties

12. **agentfeed.contract.ts** - Auth fix for reinstateFeedback() (C2)
    - Added `requireAuth(config.owner)` check
    - Only contract owner can reinstate disputed feedback

13. **deploy-testnet.sh** - Fixed init parameters (C3)
    - Changed from `(owner, min_stake, unstake_delay)` to `(owner, min_stake, feed_contract, valid_contract, escrow_contract)`

14. **deploy-mainnet.sh** - Fixed init parameters (C4)
    - Same fix as deploy-testnet.sh

15. **setup-accounts.sh** - Added agentescrow account (C5)
    - Added AGENT_ESCROW variable and included in creation loop

16. **agentfeed.contract.ts** - Fixed UserInfo type mismatch (C7)
    - Changed `verified: boolean` to `verified: u8`
    - Added missing fields: verifiedon, verifier, raccs, aacts, ac

17. **agentfeed.contract.ts** - Score calculation overflow check (C8)
    - Added check: `totalScore <= U64.MAX_VALUE / 10000` before multiplication
    - Prevents overflow in `(totalScore * 10000) / totalWeight`

18. **agentescrow.contract.ts** - Fee calculation overflow check (C9)
    - Added check before `(amount * config.platform_fee) / 10000`
    - Prevents overflow for large payment amounts

19. **agentescrow.contract.ts** - Milestone sum overflow check (C10)
    - Added check in loop: `totalMilestoneAmount <= U64.MAX_VALUE - amount`
    - Prevents integer wrap-around when accumulating milestones

### 2026-02-05 - High Priority Fixes (Current Session Continued)

20. **agentvalid.contract.ts** - Reentrancy fix in resolveChallenge (H1)
    - Moved `validatorsTable.update()` BEFORE `sendTokens()` external call
    - Tracks reward amount and recipient, sends AFTER state update

21. **agentvalid.contract.ts** - Validator accuracy cold start fix (H6)
    - Added MIN_VALIDATIONS_FOR_ACCURACY = 5 threshold
    - New validators show accuracy_score = 10001 (N/A) until minimum sample reached

22. **agentvalid.contract.ts** - Memo parsing validation (H2)
    - Added length check (1-20 chars) and digit-only validation
    - Prevents U64.parseInt panic on malformed memo

23. **agentvalid.contract.ts** - Challenge stake cap with refund (H3)
    - Refunds excess above `config.challenge_stake`
    - Stores only required amount to prevent stake inflation

24. **agentescrow.contract.ts** - Memo parsing validation (H2)
    - Same fix for job ID parsing in fund: memo

25. **agentcore.contract.ts** - Plugin-agent verification (H4)
    - Verifies agent has plugin enabled before accepting pluginResult
    - Prevents unauthorized plugin result injection

26. **agentescrow.contract.ts** - Duplicate dispute prevention (H9)
    - Checks for existing active (status=0) disputes before creating
    - Prevents both client and agent from creating separate disputes

27. **agentescrow.contract.ts** - Cascade delete for milestones (H12)
    - Deletes all milestones when job is cancelled
    - Prevents orphaned milestone records

---

## Next Steps

1. Fix remaining critical issues (C1-C10)
2. Fix high priority issues (H1-H12)
3. Run contract builds to verify no compile errors
4. Test on local environment
5. Deploy to testnet
6. Run test-actions.sh
7. Monitor for issues

---

*This document should be updated as fixes are applied.*
