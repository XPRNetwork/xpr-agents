name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # ── SDK ────────────────────────────────────
  sdk:
    name: SDK (Jest)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm install
        working-directory: sdk
      - run: npm run build
        working-directory: sdk
      - run: npm test
        working-directory: sdk

  # ── Contracts ──────────────────────────────
  contracts:
    name: Contracts (${{ matrix.contract }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        contract: [agentcore, agentfeed, agentvalid, agentescrow]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm install
        working-directory: contracts/${{ matrix.contract }}
      - run: npm run build
        working-directory: contracts/${{ matrix.contract }}
      - run: npm test
        working-directory: contracts/${{ matrix.contract }}

  # ── OpenClaw Plugin ────────────────────────
  openclaw:
    name: OpenClaw (Vitest)
    runs-on: ubuntu-latest
    needs: sdk
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm install && npm run build
        working-directory: sdk
      - run: npm install
        working-directory: openclaw
      - run: npm run build
        working-directory: openclaw
      - run: npm test
        working-directory: openclaw

  # ── Indexer ────────────────────────────────
  indexer:
    name: Indexer (Vitest)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm install
        working-directory: indexer
      - run: npm run build
        working-directory: indexer
      - run: npm test
        working-directory: indexer

  # ── Frontend ───────────────────────────────
  frontend:
    name: Frontend (Next.js)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm install
        working-directory: frontend
      - run: npm run build
        working-directory: frontend

  # ── Agent Runner ───────────────────────────
  agent-runner:
    name: Agent Runner (Build)
    runs-on: ubuntu-latest
    needs: openclaw
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm install && npm run build
        working-directory: sdk
      - run: npm install && npm run build
        working-directory: openclaw
      - run: npm install && npm run build
        working-directory: openclaw/starter/agent

  # ── Docker Build ───────────────────────────
  docker:
    name: Docker (${{ matrix.service }})
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [sdk, contracts, openclaw, indexer, frontend]
    strategy:
      fail-fast: false
      matrix:
        include:
          - service: indexer
            dockerfile: indexer/Dockerfile
          - service: agent
            dockerfile: openclaw/starter/agent/Dockerfile
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max
