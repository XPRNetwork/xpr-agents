# XPR Agents Swarm Analysis Report

**Date:** February 5, 2026
**Swarm:** 10 reviewers (Protocol, Contracts, Validation, Escrow, SDK, Frontend, Indexer, Docs, Ops, Security)
**Scope:** contracts, SDK, frontend, indexer, scripts, docs

---

## Executive Summary

This pass verifies the P2 fixes (escrow indexing, SDK singleton, validator unstake window) and re-runs an end‑to‑end consistency audit. The fixes are present, but new indexer‑level inconsistencies were found around dispute resolution mappings. Contract logic remains stable; full UX still depends on indexer correctness and frontend completeness.

**Readiness Snapshot**

| Component | Status | Notes |
|---|---|---|
| Smart Contracts | **Near-ready** | Validator unstake now blocks on any pending challenge |
| SDK | **Improved** | Config schema and agent staking alignment fixed |
| Frontend | **Partial** | Proton SDK singleton implemented; escrow UX still incomplete |
| Indexer | **Partial** | Escrow handlers added; dispute/resolve mappings incorrect |
| Docs | **Partial** | CLAUDE.md still reflects old schema |
| Scripts | **Partial** | Escrow tests still missing |

---

## Verified Fixes

1. **Challenge funding blocks canceled/resolved challenges**
File: `contracts/agentvalid/assembly/agentvalid.contract.ts`
Status: `challengeRecord.status == 0` check in transfer handler confirmed.

2. **SDK config matches agentcore**
Files: `sdk/src/types.ts`, `sdk/src/AgentRegistry.ts`
Status: `AgentCoreConfig` fields updated; `getConfig()` now matches contract table.

3. **Validator unstake window closed**
File: `contracts/agentvalid/assembly/agentvalid.contract.ts`
Status: `hasPendingChallenges()` now blocks on any pending challenge.

4. **Frontend Proton SDK singleton**
File: `frontend/src/hooks/useProton.ts`
Status: module‑level singleton + `link.login()` reuse confirmed.

5. **Indexer escrow coverage added**
Files: `indexer/src/handlers/escrow.ts`, `indexer/src/index.ts`, `indexer/src/db/schema.ts`
Status: escrow tables + handler wired into stream.

---

## New Findings

### P2 — Escrow arbitration updates wrong job
File: `indexer/src/handlers/escrow.ts`
Issue: `handleArbitrate()` updates `jobs` using `data.dispute_id` as the job id.
Impact: job state is set on the wrong row or not at all.

### P2 — Validation resolve uses challenge id as validation id
File: `indexer/src/handlers/validation.ts`
Issue: `handleResolve()` queries validations by `data.challenge_id`.
Impact: validator accuracy updates are incorrect or skipped.

### P2 — Feedback resolve uses dispute id as feedback id
File: `indexer/src/handlers/feedback.ts`
Issue: `handleResolve()` updates feedback by `data.dispute_id`.
Impact: resolved flags and score recalculations are incorrect.

### P3 — Timeout handler does not set job state
File: `indexer/src/handlers/escrow.ts`
Issue: `handleTimeout()` only updates `updated_at`, not `state`.
Impact: indexer job state can diverge from chain for timeout outcomes.

---

## Recommended Fix Order

1. Fix indexer dispute/resolve mappings (escrow arbitration, validation resolve, feedback resolve).
2. Update timeout handler to infer and set job state, or fetch on‑chain state.
3. Add escrow test flows to `scripts/test-actions.sh`.
4. Update CLAUDE.md to reflect current schema.

---

*Report generated by swarm analysis on February 5, 2026.*
